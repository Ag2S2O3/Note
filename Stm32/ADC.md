# ADC 模拟-数字转化器

## 一、ADC简介

* 关键参数：
  * 12位逐次逼近型ADC —— 表示0~2^12-1(量化结果范围：0~4095)
  * 1us转换时间 —— 从开始转换到产生结果需要花1us，频率为1MHz
* 输入电压范围：0~3.3V，转换结果范围：0~4095
* 18个输入通道，可测量16个外部（即GPIO口，直接在引脚上接模拟信号即可）和2个内部信号源（内部温度传感器和内部参考电压）
* 规则组和注入组两个转换单元（可以一次启动多个组进行转换，即多通道并行）
* 模拟看门狗自动监测输入电压范围（执行如光线强度、温度高于某个值或低于某个值的判断，当发生时模拟看门狗会申请中断，避免手动if读值）

### 1.1 逐次逼近型ADC

以下为ADC0809芯片的结构，stm32的ADC与之类似

![](images/2024-04-22-16-27-10.png)

首先IN0~IN8通过选择器输入一个信号，具体对应的通道由下方地址锁存和译码器控制；然后把这个信号与DAC输出的电压已知的一个信号放入比较器中比较，逐次修正，最终得到使DAC输出的电压与外部信号基本相等，这样DAC的输入数据就是外部电压的编码数据

### 1.2 ADC框图

接着再来看stm32的ADC

![](images/2024-04-22-16-32-33.png)

与一般的相比，它可以支持最多16通道的规则通道与最多4通道的注入通道

* 规则通道：可以一次性最多转换16组数据，但是由于上面的寄存器只有一个16位（只能接收一组），多余的15组会被挤掉，所以要配合DMA实现转换一个组就把该组数据搬运到其他地方，防止数据丢失
* 注入通道：由于有4个寄存器对应4组通道，所以就不需要担心被覆盖的问题了

一般使用规则组+DMA转运即可

![](images/2024-04-22-16-42-24.png)

ADC主模块的下方还有它的触发方式，分为软件触发（调用一条代码启动转换）和硬件触发（图示接线，触发源主要来自定时器或者TRGO（TRGO来触发ADC转换不需要进入中断，防止了CPU被大量中断请求卡住的情况），当然也可以选择外部触发）

![](images/2024-04-22-16-42-38.png)

右侧是用于驱动内部逐次比较的时钟，来自ADC预分频器，**最大14MHz**（由于APB2最大72Mhz，通过预分频器进行分频要满足这个条件，故只能选择**6分频12MHz和8分频9MHz**）

![](images/2024-04-22-16-46-29.png)

上方则是其转换结束或者触发看门狗后会将标志位置1，或者去到中断，提醒我们相应的情况

### 1.3 ADC基本结构

![](images/2024-04-22-16-50-12.png)

#### 1.3.1 输入通道

![](images/2024-04-22-16-52-29.png)

ADC1和ADC2共用一个通道，使用时选择一个ADC即可（双ADC模式暂可不用掌握）

#### 1.3.2 转换模式

* **单次转换** —— 触发后只转换一次，想要再转换就要再触发
* **连续转换** —— 在一次转换后立即开始新一轮的转换

</br>

* **非扫描模式** ——一次只转换一个通道的数据，转换完后EOC置1
* **扫描模式** —— 一次转换设置的通道数目的序列，全部转换完成后再将EOC置1（因为有之前提及的“覆盖”问题，所以要用DMA及时将数据搬走）
  
#### 1.3.3 触发控制

写程序的时候参考

![](images/2024-04-22-17-00-04.png)

#### 1.3.4 数据对齐

由于ADC是12位的而寄存器是16位的，所以要选择数据的对齐方式

![](images/2024-04-22-17-01-04.png)

一般选择右对齐（左对齐读出来的数会比较大）

#### 1.3.5 校准

>· ADC有一个内置自校准模式。校准可大幅减小因内部电容器组的变化而造成的准精度误差。校准期间，在每个电容器上都会计算出一个误差修正码(数字值)，这个码用于消除在随后的转换中每个电容器上产生的误差
· 建议在每次上电后执行一次校准
· 启动校准前， ADC必须处于关电状态超过至少两个ADC时钟周期

其实不需要管校准原理，只需要知道在ADC初始化的最后加几行校准代码即可


## 二、初始化ADC

依旧是打通1.3中的结构图

**1. 开启RCC时钟，包含ADC和GPIO时钟**（记得还要配置ADCCLK的分频器）

**2. 配置GPIO为模拟输入**

**3. 配置多路开关，连接通道与规则组**

**4. 配置ADC转换器**

**5. 开关控制，启动ADC，校准ADC**

（如果要中断或者看门狗，需要在4~5之间加入相应的配置）

